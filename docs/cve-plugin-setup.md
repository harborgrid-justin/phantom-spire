# Phantom CVE Core Plugin Setup Guide

This guide explains how to set up the extended Phantom CVE Core plugin with multi-database support for business SaaS readiness.

## Overview

The Phantom CVE Core plugin now supports multiple data stores to provide enterprise-grade capabilities:

- **Redis**: High-performance caching and real-time operations
- **PostgreSQL**: ACID-compliant relational storage and analytics  
- **MongoDB**: Flexible document storage (already supported)
- **Elasticsearch**: Advanced search and analytics capabilities

## Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   CVE Controller │────│  CVE Data       │────│  Data Sources   │
│                 │    │  Service        │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                │                       ├── Redis (Cache)
                                │                       ├── PostgreSQL (Analytics)  
                                │                       ├── MongoDB (Primary)
                                │                       └── Elasticsearch (Search)
                                │
                        ┌─────────────────┐
                        │  Multi-DB       │
                        │  Orchestrator   │
                        └─────────────────┘
```

## Quick Setup

### 1. Install Dependencies

```bash
npm install redis pg @elastic/elasticsearch
npm install @types/pg --save-dev
```

### 2. Start Database Services

```bash
# Start all databases with Docker Compose
docker-compose up -d postgres mongodb redis elasticsearch

# Verify services are running
docker-compose ps
```

### 3. Configure Environment Variables

Create or update your `.env` file:

```env
# Multi-Database Configuration
MONGODB_URI=mongodb://admin:phantom_secure_pass@localhost:27017/phantom_spire?authSource=admin
POSTGRESQL_URI=postgresql://postgres:phantom_secure_pass@localhost:5432/phantom_spire
REDIS_URL=redis://:phantom_redis_pass@localhost:6379/0
ELASTICSEARCH_URL=http://localhost:9200

# CVE Plugin Configuration
CVE_READ_PREFERENCE=cache-first
CVE_WRITE_STRATEGY=dual
CVE_CONSISTENCY_LEVEL=eventual
CVE_CACHE_INVALIDATION=immediate

# Business SaaS Features
CVE_MULTI_TENANCY=true
CVE_DATA_RETENTION=365
CVE_AUDIT_LOGGING=true
CVE_ENCRYPTION=true
CVE_BACKUPS=true

# Database Roles
CVE_MONGODB_ROLE=primary
CVE_REDIS_ROLE=cache
CVE_POSTGRESQL_ROLE=analytics
CVE_ELASTICSEARCH_ROLE=search
```

### 4. Initialize in Your Application

```typescript
import { initializePhantomCVECore } from './src/plugins/cveCore.js';

// Initialize the plugin
const result = await initializePhantomCVECore();

if (result.success) {
  console.log('✅ CVE Core initialized:', result.message);
  console.log('📊 SaaS Readiness:', result.configuration.summary.businessSaasReadiness.level);
} else {
  console.error('❌ CVE Core initialization failed:', result.errors);
}
```

### 5. Test the Setup

```bash
# Check plugin health
curl http://localhost:3000/api/cve/health

# Get CVE statistics
curl http://localhost:3000/api/cve/statistics

# Search CVEs
curl "http://localhost:3000/api/cve/search?q=critical&limit=10"
```

## Configuration Options

### Read Preferences

- **cache-first**: Try Redis cache first, fallback to primary database
- **primary**: Always read from primary database (MongoDB/PostgreSQL)
- **distributed**: Try multiple sources and return first successful result

### Write Strategies

- **single**: Write to primary database only
- **dual**: Write to primary and cache simultaneously
- **all**: Write to all configured databases

### Consistency Levels

- **eventual**: Allow eventual consistency across databases
- **strong**: Ensure strong consistency (slower performance)
- **bounded**: Bounded staleness with configurable limits

## Business SaaS Readiness

The plugin automatically assesses your configuration and assigns a readiness level:

### Basic (Score: 0-50)
- Single database configured
- Basic functionality available
- Limited scalability

### Professional (Score: 51-75)
- 2+ databases configured  
- Caching or search capabilities
- Good for small-medium businesses

### Enterprise (Score: 76-100)
- 3+ databases configured
- Full multi-database capabilities
- Advanced features enabled
- Production-ready for large organizations

## API Endpoints

### Core CVE Operations

```
GET    /api/cve/cves              # List CVEs with filtering
POST   /api/cve/cves              # Create new CVE
GET    /api/cve/cves/:id          # Get CVE by ID
PUT    /api/cve/cves/:id          # Update CVE
DELETE /api/cve/cves/:id          # Delete CVE
GET    /api/cve/search            # Search CVEs
```

### Analytics and Stats

```
GET    /api/cve/statistics        # Get CVE statistics
GET    /api/cve/analytics/risk    # Risk assessment analytics
GET    /api/cve/health           # Plugin health status
```

## Database Schemas

### PostgreSQL Schema

The plugin automatically creates the following tables:

- `cve_data.cves` - Main CVE records
- `cve_data.affected_products` - Product relationships
- `cve_data.references` - External references
- `cve_data.weaknesses` - CWE mappings

### Elasticsearch Mapping

Optimized for:
- Full-text search on title and description
- Faceted search on severity, vendor, product
- Aggregations for analytics
- Nested objects for complex relationships

### Redis Structure

- `phantom:cve:cve:{id}` - Cached CVE records
- `phantom:cve:idx:severity:{level}` - Severity indexes
- `phantom:cve:stats:global` - Cached statistics
- `phantom:cve:updates` - Real-time update notifications

## Performance Optimization

### Caching Strategy

1. **L1 Cache**: Redis for frequently accessed CVEs
2. **L2 Cache**: Application-level caching for statistics
3. **Smart Invalidation**: Immediate cache updates on writes

### Search Optimization

1. **Elasticsearch**: Primary search engine for complex queries
2. **PostgreSQL**: Fallback for relational queries
3. **Index Optimization**: Automatic index creation and management

### Write Optimization

1. **Async Writes**: Non-blocking writes to secondary stores
2. **Batch Processing**: Bulk operations for data imports
3. **Connection Pooling**: Efficient database connections

## Troubleshooting

### Common Issues

**Service Not Initialized**
```bash
# Check environment variables
env | grep -E "(MONGODB|REDIS|POSTGRES|ELASTICSEARCH)"

# Verify database connectivity
docker-compose ps
```

**Database Connection Failed**
```bash
# Test individual connections
redis-cli -h localhost -p 6379 ping
psql -h localhost -p 5432 -U postgres -d phantom_spire -c "SELECT 1;"
```

**Search Not Working**
```bash
# Check Elasticsearch status
curl http://localhost:9200/_cluster/health
```

### Debug Mode

Enable debug logging:

```env
LOG_LEVEL=debug
CVE_DEBUG=true
```

## Migration from In-Memory Storage

The plugin automatically migrates from the previous in-memory Map storage to the new multi-database architecture. No data loss occurs during the transition.

## Security Considerations

1. **Encryption**: Enable encryption for sensitive data
2. **Access Control**: Configure database-level security
3. **Audit Logging**: Track all CVE operations
4. **Network Security**: Use SSL/TLS for database connections

## Monitoring and Alerts

### Health Checks

The plugin provides comprehensive health checks:

```typescript
import { healthCheckCVECore } from './src/plugins/cveCore.js';

const health = await healthCheckCVECore();
console.log('Health Status:', health.status);
console.log('Capabilities:', health.capabilities);
```

### Metrics

Monitor key metrics:
- Database connection health
- Cache hit rates
- Query performance
- Error rates

## Support

For technical support or questions:

1. Check the [GitHub Issues](https://github.com/harborgrid-justin/phantom-spire/issues)
2. Review the configuration guide above
3. Enable debug logging for detailed troubleshooting
4. Contact the development team with specific error messages

---

**Phantom CVE Core Plugin** - Extended for business SaaS readiness with Redis, PostgreSQL, MongoDB, and Elasticsearch support.