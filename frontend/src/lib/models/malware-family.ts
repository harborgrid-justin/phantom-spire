// Malware Family Sequelize Model
import { DataTypes, Sequelize, Model } from 'sequelize';

export interface MalwareFamilyAttributes {
  id: string;
  name: string;
  aliases: string[];
  description: string;
  category: 'trojan' | 'ransomware' | 'worm' | 'virus' | 'backdoor' | 'rootkit' | 'spyware' | 'adware' | 'other';
  platform: string[];
  first_seen: Date;
  last_seen: Date;
  is_active: boolean;
  created_at: Date;
  updated_at: Date;
}

export class MalwareFamily extends Model<MalwareFamilyAttributes> implements MalwareFamilyAttributes {
  public id!: string;
  public name!: string;
  public aliases!: string[];
  public description!: string;
  public category!: 'trojan' | 'ransomware' | 'worm' | 'virus' | 'backdoor' | 'rootkit' | 'spyware' | 'adware' | 'other';
  public platform!: string[];
  public first_seen!: Date;
  public last_seen!: Date;
  public is_active!: boolean;
  public readonly created_at!: Date;
  public readonly updated_at!: Date;

  public static associate(models: any) {
    MalwareFamily.belongsToMany(models.IOC, {
      through: 'ioc_malware_families',
      foreignKey: 'malware_family_id',
      otherKey: 'ioc_id',
      as: 'iocs'
    });
  }
}

export function MalwareFamilyModel(sequelize: Sequelize) {
  MalwareFamily.init(
    {
      id: {
        type: DataTypes.UUID,
        primaryKey: true,
        defaultValue: DataTypes.UUIDV4
      },
      name: {
        type: DataTypes.STRING(255),
        allowNull: false,
        unique: true
      },
      aliases: {
        type: DataTypes.JSON,
        allowNull: false,
        defaultValue: []
      },
      description: {
        type: DataTypes.TEXT,
        allowNull: false
      },
      category: {
        type: DataTypes.ENUM('trojan', 'ransomware', 'worm', 'virus', 'backdoor', 'rootkit', 'spyware', 'adware', 'other'),
        allowNull: false
      },
      platform: {
        type: DataTypes.JSON,
        allowNull: false,
        defaultValue: []
      },
      first_seen: {
        type: DataTypes.DATE,
        allowNull: true
      },
      last_seen: {
        type: DataTypes.DATE,
        allowNull: true
      },
      is_active: {
        type: DataTypes.BOOLEAN,
        allowNull: false,
        defaultValue: true
      },
      created_at: {
        type: DataTypes.DATE,
        allowNull: false
      },
      updated_at: {
        type: DataTypes.DATE,
        allowNull: false
      }
    },
    {
      sequelize,
      modelName: 'MalwareFamily',
      tableName: 'malware_families',
      timestamps: true,
      createdAt: 'created_at',
      updatedAt: 'updated_at',
      indexes: [
        {
          fields: ['name']
        },
        {
          fields: ['category']
        },
        {
          fields: ['is_active']
        }
      ]
    }
  );

  return MalwareFamily;
}
